name: ğŸš€ ATS Dedicated Server Deployment on Linode

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deployment_mode:
        description: 'Deployment mode'
        required: true
        type: choice
        options:
          - 'full-deploy'
          - 'test-only'
          - 'server-only'
        default: 'full-deploy'
      create_new_server:
        description: 'Create new Linode server'
        required: false
        type: boolean
        default: false

jobs:
  # ============================================================================
  # Stage 0: Pre-flight Checks & Validation
  # ============================================================================
  preflight-checks:
    name: ğŸ›« Pre-flight Checks
    runs-on: self-hosted
    outputs:
      deployment_mode: ${{ steps.config.outputs.deployment_mode }}
      should_create_server: ${{ steps.config.outputs.should_create_server }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Configure deployment
        id: config
        run: |
          echo "ğŸ¯ Configuring deployment..."
          DEPLOYMENT_MODE="${{ github.event.inputs.deployment_mode || 'full-deploy' }}"
          SHOULD_CREATE="${{ github.event.inputs.create_new_server || 'false' }}"
          
          echo "deployment_mode=$DEPLOYMENT_MODE" >> $GITHUB_OUTPUT
          echo "should_create_server=$SHOULD_CREATE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Deployment Configuration:"
          echo "  - Mode: $DEPLOYMENT_MODE"
          echo "  - Create new server: $SHOULD_CREATE"

      - name: ğŸ” Validate Required Secrets
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          ATS_ROOT_PASSWORD: ${{ secrets.ATS_ROOT_PASSWORD }}
          ACTIONS_USER_PASSWORD: ${{ secrets.ACTIONS_USER_PASSWORD }}
        run: |
          echo "ğŸ” Validating required secrets..."
          
          MISSING_COUNT=0
          
          # Check each required secret
          if [ -z "$LINODE_TOKEN" ]; then
            echo "âŒ Missing: LINODE_TOKEN - Linode API token for server provisioning"
            MISSING_COUNT=$((MISSING_COUNT + 1))
          else
            echo "âœ… Found: LINODE_TOKEN"
          fi
          
          if [ -z "$ATS_ROOT_PASSWORD" ]; then
            echo "âŒ Missing: ATS_ROOT_PASSWORD - Root password for ATS server"
            MISSING_COUNT=$((MISSING_COUNT + 1))
          else
            echo "âœ… Found: ATS_ROOT_PASSWORD"
          fi
          
          if [ -z "$ACTIONS_USER_PASSWORD" ]; then
            echo "âŒ Missing: ACTIONS_USER_PASSWORD - Password for actions user account"
            MISSING_COUNT=$((MISSING_COUNT + 1))
          else
            echo "âœ… Found: ACTIONS_USER_PASSWORD"
          fi
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo ""
            echo "âŒ Missing $MISSING_COUNT required secret(s)"
            echo "ğŸ“‹ To fix: Go to https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          echo ""
          echo "âœ… All required secrets validated"

  # ============================================================================
  # Stage 1: Server Setup
  # ============================================================================
  setup-server:
    name: ğŸ—ï¸ Setup Linode Server
    runs-on: self-hosted
    needs: [preflight-checks]
    if: needs.preflight-checks.outputs.deployment_mode != 'test-only'
    outputs:
      server_ip: ${{ steps.server-result.outputs.server_ip }}
      server_id: ${{ steps.server-result.outputs.server_id }}
      server_created: ${{ steps.server-result.outputs.server_created }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Environment
        run: |
          echo "ğŸ”§ Setting up environment..."
          
          # Ensure script is executable
          if [ -f "scripts/deployment/create-ats-server.sh" ]; then
            chmod +x scripts/deployment/create-ats-server.sh
          else
            echo "âŒ Deployment script not found!"
            exit 1
          fi
          
          # Install required tools
          if ! command -v pip3 &>/dev/null; then
            if command -v pacman >/dev/null 2>&1; then
              sudo -n pacman -S --noconfirm python python-pip
            elif command -v apt-get >/dev/null 2>&1; then
              sudo -n apt-get update && sudo -n apt-get install -y python3 python3-pip
            fi
          fi
          
          # Install Linode CLI
          echo "ğŸ“¦ Installing Linode CLI..."
          pip3 install --user linode-cli --quiet
          export PATH="$HOME/.local/bin:$PATH"
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV
          
          # Configure Linode CLI to avoid interactive prompts
          echo "ğŸ”§ Configuring Linode CLI..."
          mkdir -p ~/.config/linode-cli
          echo "[DEFAULT]" > ~/.config/linode-cli/config
          echo "default-user = DEFAULT" >> ~/.config/linode-cli/config
          echo "region = ca-central" >> ~/.config/linode-cli/config
          echo "type = g6-standard-2" >> ~/.config/linode-cli/config
          echo "image = linode/ubuntu22.04" >> ~/.config/linode-cli/config
          echo "token = ${{ secrets.LINODE_TOKEN }}" >> ~/.config/linode-cli/config
          chmod 600 ~/.config/linode-cli/config
          
          echo "âœ… Environment setup complete"

      - name: ğŸš€ Create/Detect Server
        id: create
        run: |
          echo "ğŸš€ Running server creation/detection..."
          
          CREATE_FLAG=""
          if [ "${{ needs.preflight-checks.outputs.should_create_server }}" == "true" ]; then
            CREATE_FLAG="--force-new"
          fi
          
          # Run the server creation script
          ./scripts/deployment/create-ats-server.sh $CREATE_FLAG
          
          # Check if server details were generated
          if [ -f "server-details.env" ]; then
            source server-details.env
            echo "server_ip=${SERVER_IP:-}" >> $GITHUB_OUTPUT
            echo "server_id=${SERVER_ID:-unknown}" >> $GITHUB_OUTPUT
            echo "server_created=${IS_NEW_SERVER:-false}" >> $GITHUB_OUTPUT
            echo "âœ… Server details captured"
          else
            echo "âŒ Server details not found"
            exit 1
          fi
        env:
          LINODE_CLI_TOKEN: ${{ secrets.LINODE_TOKEN }}
          ROOT_PASSWORD: ${{ secrets.ATS_ROOT_PASSWORD }}
          ACTIONS_USER_PASSWORD: ${{ secrets.ACTIONS_USER_PASSWORD }}

      - name: ğŸ“Š Server Setup Results
        id: server-result
        if: always()
        run: |
          echo "server_ip=${{ steps.create.outputs.server_ip }}" >> $GITHUB_OUTPUT
          echo "server_id=${{ steps.create.outputs.server_id }}" >> $GITHUB_OUTPUT
          echo "server_created=${{ steps.create.outputs.server_created }}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Server Setup Summary:"
          echo "  - Server IP: ${{ steps.create.outputs.server_ip }}"
          echo "  - Server ID: ${{ steps.create.outputs.server_id }}"
          echo "  - New Server: ${{ steps.create.outputs.server_created }}"

  setup-ats:
    name: Setup ATS Dedicated Server
    #runs-on: ubuntu-latest
    runs-on: self-hosted

    needs: setup-server
    steps:
      - name: SSH and Install SteamCMD
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ needs.setup-server.outputs.server_ip }}
          username: root
          password: ${{ secrets.ATS_ROOT_PASSWORD }}
          script: |
            apt-get update && apt-get install -y steamcmd
            mkdir -p /home/ats-server
            steamcmd +login anonymous +force_install_dir /home/ats-server +app_update 2239530 validate +quit

      - name: Configure and Start Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ needs.setup-server.outputs.server_ip }}
          username: root
          password: ${{ secrets.ATS_ROOT_PASSWORD }}
          script: |
            ufw allow 27015:27020/tcp
            ufw allow 27015:27020/udp
            echo 'server_config.sii contents' > /home/ats-server/server_config.sii
            echo 'server_packages.sii contents' > /home/ats-server/server_packages.sii
            chmod +x /home/ats-server/start_ats_server.sh
            /home/ats-server/start_ats_server.sh

